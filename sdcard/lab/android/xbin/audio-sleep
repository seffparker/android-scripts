#!/data/bin/bash

## Auto-stop media playback and turn off Bluetooth
## Author: Seff P
## Version: 4.2.0 20210607

source /sdcard/lab/android/etc/bashrc.root
source check-root
source set-dir
source set-prompt

PID_FILE=$RUN/audio-sleep.pid
STATUS=$VAR/audio-sleep.left
EXTEND=30
KEEP_STATUS=false
[[ -f $ETC/audio-sleep.conf ]] && source $ETC/audio-sleep.conf

daemon_run () {
    tty -s && exec &> >(logdate)
    termux-wake-lock
    for ((MIN=$1; MIN > 0; MIN--))
    do
        echo "$MIN minutes left to sleep"
        echo -n ${MIN} > ${STATUS}
        termux-notification --alert-once --ongoing --id audio-sleep \
        -t "Audio player will stop in $MIN minutes" \
        --button1 "+${EXTEND}m" \
        --button1-action "su -c '$0 +${EXTEND}'"\
        --button2 "Custom" \
        --button2-action "su -c '$0 \$REPLY'"\
        --button3 "Abort" \
        --button3-action "su -c '$0 0'" \
        --icon timer
        sleep 60 || exit
    done
    echo -n 0 > ${STATUS}
    termux-notification --content "Audio player is being stopped" \
        --ongoing --id audio-sleep \
        --button1 "Extend ${EXTEND}m" \
        --button1-action "su -c '$0 ${EXTEND}'" \
        --icon timer
    echo "Audio player is being stopped" 
    ORG_VOL=$(termux-volume | awk '/music/ {getline; print $2+0}')
    for VOL in $(seq $ORG_VOL | sort -nr)
        do
        termux-volume music $VOL
        echo "Current volume is $VOL"
        sleep 10
        done
    echo "Sending event to stop media"
    input keyevent 86 # stop media
    echo "Restoring volume back to $ORG_VOL"
    termux-volume music $ORG_VOL # restore volume
    echo "Turning off Bluetooth and Internet"
    /system/bin/svc bluetooth disable
    /system/bin/svc data disable
    /system/bin/svc wifi disable
    rm -fv $PID_FILE $STATUS
    termux-notification-remove audio-sleep
    termux-wake-unlock
    echo "Exiting cleanly"
}

print_usage () {
    echo "USAGE:"
    echo -e "\t`basename $0` <minutes-to-sleep>"
    echo -e "\t`basename $0` +<minutes-to-extend>"
    echo -e "\t`basename $0` 0 <zero-to-abort>"
    exit 1
}

daemon_stop () {
    echo -n "Aborting audio-sleep "
    if daemon -t -p $PID_FILE -c $0
    then
        PID=$(cat $PID_FILE)
        busybox pkill -9 -P $PID &> /dev/null
        daemon -k -p $PID_FILE -c $0
        termux-wake-unlock
        $KEEP_STATUS || termux-notification-remove audio-sleep
        rm -f $STATUS $PID_FILE
        DONE
    else
        rm -f $STATUS $PID_FILE
        termux-notification-remove audio-sleep
        OK
    fi
}

daemon_start () {
    echo -ne "Setting sleep timer to $1 minutes "
    if daemon -s -p $PID_FILE -c $0 -a "run $1"
        then
        DONE
    else
        FAIL
    fi
}

case $1 in
    run)
        [[ $2 -gt 0 ]] && daemon_run $2 || print_usage
        ;;
    0)
        daemon_stop
        ;;
    +[1-9]*)
        KEEP_STATUS=true
        MIN_LEFT=$(cat $STATUS 2> /dev/null)
        let MIN=${MIN_LEFT}${1}
        daemon_stop &> /dev/null
        daemon_start $MIN
        ;;
    [1-9]*)
        KEEP_STATUS=true
        daemon_stop &> /dev/null
        daemon_start $1
        ;;
    *)
        print_usage
        ;;
esac