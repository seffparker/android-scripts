#!/system/xbin/bash

## Daily routine tasks
## Author: Seff P
## Version: 20191210

source check-root
source logdate
source setdir
source setcolor

DATE_LOG="$LOG/daily-jobs.datelog"
NET=NOT_CONNECTED
J=1 # Index of first job
N=5 # Total no. of jobs

notify () {
    termux-notification --ongoing --id dailyjobs --title "Running daily jobs: $1/$N" --content "$2"
    }

echo -e "$(logdate) daily-jobs $(BEGIN)"
echo -en "$(logdate) Holding wake-lock "
termux-wake-lock; DONE
echo "$(logdate) SHELL=$BASH $BASH_VERSION"

notify 0 "Preparing..."

logdate && uptime
check-ping && NET=CONNECTED

if [[ $BG && "$NET" == "NOT_CONNECTED" ]]
    then
    notify 0 "Waiting 15 seconds for Internet..."
    echo -e "$(logdate) Waiting for Internet"
    vibrate 3
    sleep 15
    check-ping && NET=CONNECTED
    fi

if [[ $NET == "CONNECTED" ]]
    then
    notify $J "Checking adblock updates..."
    adblock update -s
fi
((J++))

notify $J "Optimizing memory & cache..."
optimize-cache
optimize-memory
((J++))


notify $J "Generating maintenance report..."
echo "$(logdate) $(pkg-update report)"
echo "$(logdate) $(backup-sdcard report)"
echo "$(logdate) $(optimize-db report)"
((J++))

notify $J "Detaching apps from PlayStore..."
detach-from-playstore --all
((J++))


# Finalize
notify $J "Finishing up..."
sed -i 1d $DATE_LOG
echo "$(logdate) $NET" >> $DATE_LOG
echo -e "$(logdate) daily-jobs $(DONE)"
echo -en "$(logdate) Releasing wake-lock "
termux-notification-remove dailyjobs
vibrate 1
termux-wake-unlock
DONE