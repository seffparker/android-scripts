#!/system/xbin/bash

## Auto-stop media playback and turn off Bluetooth
## Author: Seff P
## Version: 20200505


source check-root
source set-dir
source set-color
source /.bashrc

PID_FILE=$RUN/audio-sleep.pid
STATUS=$VAR/audio-sleep.left

sleep_daemon () {
    termux-wake-lock
    for MIN in $(seq $1 | sort -nr)
    do
        echo -n ${MIN} > ${STATUS}
        termux-notification --alert-once --ongoing --id audio-sleep \
        --content "Audio player will stop in $MIN minutes" \
        --button1 "Abort" \
        --button1-action "su -c '$0 0'" \
        --button2 "Extend 30m" \
        --button2-action "su -c '$0 +30'"\
        &
        sleep 60
    done
    echo -n 0 > ${STATUS}
    termux-notification --content "Audio player is being stopped" \
        --ongoing --id audio-sleep \
        --button1 "Extend 30m" \
        --button1-action "su -c '$0 +30'"
    CUR_VOL=$(termux-volume | awk '/music/ {getline; print $2+0}')
    for VOL in $(seq $CUR_VOL | sort -nr)
        do
        termux-volume music $VOL
        sleep 5
        done
    input keyevent 86 # stop media
    termux-volume music $CUR_VOL
    service call bluetooth_manager 8 &> /dev/null # diable bluetooth
    rm -f $PID_FILE $STATUS
    termux-notification-remove audio-sleep
    termux-wake-unlock
}

print_usage () {
    echo "USAGE:"
    echo -e "\t`basename $0` <minutes-to-sleep>"
    echo -e "\t`basename $0` +<minutes-to-extend>"
    echo -e "\t`basename $0` 0 <zero-to-abort>"
    exit 1
}

sleep_stop () {
    PID=$(cat $PID_FILE 2> /dev/null)
    if pgrep -f $0 | grep -wq "^${PID}$"
    then
        echo -ne "INFO: Canceling audio-sleep "
        kill -9 $PID &> /dev/null
        pkill -xf "sleep 60"
        rm -f $PID_FILE $STATUS &> /dev/null
        termux-notification-remove audio-sleep
        termux-wake-unlock
        DONE
    else
        echo -e "NOTICE: No sleep job to turn off $(SKIP)"
    fi
}

sleep_extend () {
    MIN_LEFT=$(cat $STATUS 2> /dev/null)
    let MIN=${MIN_LEFT}${1}
    sleep_start $MIN
}

sleep_start () {
    sleep_stop &> /dev/null
    echo -ne "INFO: Setting sleep timer to $1 minutes "
    sleep_daemon $1 &>/dev/null &
    echo $! > $PID_FILE
    DONE
}

case $1 in
    0)
       sleep_stop
       ;;
    [1-9]*)
       sleep_start $1
       ;;
    +[1-9]*)
       sleep_extend $1
       ;;
    *)
       print_usage
       ;;
esac