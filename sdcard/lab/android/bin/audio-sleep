#!/system/xbin/bash

## Auto-stop media players and turn off Bluetooth
## Author: Seff P
## Version: 20200504


source check-root
source setdir
source setcolor
source /.bashrc

MY_PID=$RUN/audio-sleep.pid
STATUS=$VAR/audio-sleep.left

daemon () {
    termux-wake-lock
    for MIN in $(seq $1 | sort -nr)
    do
        echo -n ${MIN} > ${STATUS}
        termux-notification --content "Audio player will stop in $MIN minutes" --ongoing --id audio-sleep --alert-once \
        --button1 "Abort" \
        --button1-action "su -c 'audio-sleep 0'"\
        --button2 "Extend 30m" \
        --button2-action "su -c 'audio-sleep +30'"\
        &
        sleep 60
    done
    termux-notification --content "Audio player is being stopped" --ongoing --id audio-sleep
    CUR_VOL=$(termux-volume | awk '/volume/ {i++} i==7 {print ($2+0)}')
    for VOL in $(seq $CUR_VOL | sort -nr)
        do
        termux-volume music $VOL
        sleep 5
        done
    input keyevent 85 # pause media
    termux-volume music $CUR_VOL
    service call bluetooth_manager 8 &> /dev/null
    rm -f $MY_PID $STATUS
    termux-notification-remove audio-sleep
    termux-wake-unlock
}

print_usage () {
    echo "USAGE:"
    echo -e "\t`basename $0` <minutes-to-sleep>"
    echo -e "\t`basename $0` +<minutes-to-extend>"
    echo -e "\t`basename $0` 0 <zero-to-abort>"
    exit 1
}

stop () {
    if kill -9 $(cat $MY_PID 2> /dev/null) &> /dev/null
    then
        pkill -xf "sleep 60"
        echo -ne "INFO: Canceling audio-sleep "
        rm -f $MY_PID $STATUS &> /dev/null
        termux-notification-remove audio-sleep
        termux-wake-unlock
        DONE
    else
        echo -e "NOTICE: No sleep job to turn off $(SKIP)"
    fi
}

extend () {
    MIN_LEFT=$(cat $STATUS)
    let MIN=${MIN_LEFT}${1}
    start $MIN
}

start () {
if kill -0 $(cat $MY_PID 2> /dev/null) &> /dev/null
    then stop &> /dev/null
fi
    echo -ne "INFO: Scheduling audio player to turn off after $1 minutes "
    daemon $1 &>/dev/null &
    echo $! > $MY_PID
    DONE
}

case $1 in
    0)
       stop
       ;;
    [1-9]*)
       start $1
       ;;
    +[1-9]*)
       extend $1
       ;;
    *)
       print_usage
       ;;
esac